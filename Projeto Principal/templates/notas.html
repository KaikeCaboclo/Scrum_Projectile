{% extends 'base.html' %}

{% block title %}Notas | SCRUM ACADEMY{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<h2 class="titulo">Notas dos Exercic√≠os:</h2>
<section class="area_graficos">
    <div class="graficos">
        <canvas id="grafico_modulo1"></canvas>
        <p>M√≥dulo 1 - Introdu√ß√£o ao Scrum </p>
    </div>

    <div class="graficos">
        <canvas id="grafico_modulo2"></canvas>
        <p>M√≥dulo 2 - Fundamentos do Agile </p>
    </div>

    <div class="graficos">
        <canvas id="grafico_modulo3"></canvas>
        <p>M√≥dulo 3 - Pap√©is</p>
    </div>

    <div class="graficos">
        <canvas id="grafico_modulo4"></canvas>
        <p>M√≥dulo 4 - Eventos e Cerim√¥nias</p>
    </div>

    <div class="graficos">
        <canvas id="grafico_modulo5"></canvas>
        <p>M√≥dulo 5 - Artefatos </p>
    </div>

    <div class="graficos">
        <canvas id="grafico_modulo6"></canvas>
        <p>M√≥dulo 6 - Estimativa e Planejamento </p>
    </div>

    <div class="graficos">
        <canvas id="grafico_modulo7"></canvas>
        <p>M√≥dulo 7 - Scrum Board e Ferramentas </p>
    </div>

    <div class="graficos">
        <canvas id="grafico_modulo8"></canvas>
        <p>M√≥dulo 8 - Boas Pr√°ticas e Dicas </p>
    </div>

     <div class="graficos">
        <canvas id="ExameFinalNotas"></canvas>
        <p>Exame Final</p>
    </div>
</section>

<!-- SE√á√ÉO DO CERTIFICADO -->
<section id="certificado-section" class="certificado-section certificado-bloqueado">
    <div class="certificado-header">
        <div class="certificado-icon">üèÜ</div>
        <h2 class="certificado-title">Certificado de Conclus√£o</h2>
        <p class="certificado-descricao">
            Complete 100% do curso e o Exame Final para desbloquear seu certificado oficial da SCRUM ACADEMY!
        </p>
    </div>
    
    <!-- PROGRESSO VISUAL -->
    <div class="certificado-progresso-visual">
        <div class="progresso-circle">
            <canvas id="grafico-progresso-certificado"></canvas>
            <div class="progresso-texto">
                <span class="progresso-numero" id="progresso-percent-display">0%</span>
                <span class="progresso-label">Completo</span>
            </div>
        </div>
        
        <div class="progresso-info">
            <div class="info-item">
                <span class="info-icon">üìö</span>
                <div class="info-content">
                    <strong id="topicos-concluidos">0/43</strong>
                    <span>T√≥picos Conclu√≠dos</span>
                </div>
            </div>
            
            <div class="info-item">
                <span class="info-icon">‚úèÔ∏è</span>
                <div class="info-content">
                    <strong id="exercicios-aprovados">0/8</strong>
                    <span>Exerc√≠cios Aprovados</span>
                </div>
            </div>

            <div class="info-item">
                <span class="info-icon" id="exame-final-icon">‚è≥</span>
                <div class="info-content">
                    <strong id="exame-final-nota">0%</strong>
                    <span>Exame Final</span>
                </div>
            </div>
            
            <div class="info-item">
                <span class="info-icon" id="status-icon">‚è≥</span>
                <div class="info-content">
                    <strong id="status-texto">Em Progresso</strong>
                    <span id="status-mensagem">Continue estudando!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MENSAGEM DE ORIENTA√á√ÉO -->
    <div class="certificado-orientacao">
        <div class="orientacao-card">
            <h3>üìã Como desbloquear o certificado?</h3>
            <ol class="orientacao-lista">
                <li>
                    <strong>Estude todo o conte√∫do:</strong> Leia cada t√≥pico dos 9 m√≥dulos dispon√≠veis
                </li>
                <li>
                    <strong>Marque as checkboxes:</strong> Ao finalizar cada t√≥pico, marque a checkbox ao lado para registrar seu progresso
                </li>
                <li>
                    <strong>Complete os exerc√≠cios:</strong> Fa√ßa os question√°rios de cada m√≥dulo (recomendado: nota ‚â• 70%)
                </li>
                <li>
                    <strong>Exame Final:</strong> Complete o Exame Final com nota m√≠nima de 70%!
                </li>
            </ol>
        </div>
    </div>

    <!-- DETALHES DOS M√ìDULOS (OPCIONAL - MOSTRA PROGRESSO POR M√ìDULO) -->
    <details class="modulos-detalhes">
        <summary>üìä Ver progresso detalhado por m√≥dulo</summary>
        <div class="modulos-grid">
            <div class="modulo-mini" id="mini-modulo1">
                <span class="modulo-numero">1</span>
                <span class="modulo-nome">Introdu√ß√£o ao Scrum</span>
                <span class="modulo-nota" id="nota-modulo1">0%</span>
            </div>
            <div class="modulo-mini" id="mini-modulo2">
                <span class="modulo-numero">2</span>
                <span class="modulo-nome">Fundamentos do Agile</span>
                <span class="modulo-nota" id="nota-modulo2">0%</span>
            </div>
            <div class="modulo-mini" id="mini-modulo3">
                <span class="modulo-numero">3</span>
                <span class="modulo-nome">Pap√©is</span>
                <span class="modulo-nota" id="nota-modulo3">0%</span>
            </div>
            <div class="modulo-mini" id="mini-modulo4">
                <span class="modulo-numero">4</span>
                <span class="modulo-nome">Eventos e Cerim√¥nias</span>
                <span class="modulo-nota" id="nota-modulo4">0%</span>
            </div>
            <div class="modulo-mini" id="mini-modulo5">
                <span class="modulo-numero">5</span>
                <span class="modulo-nome">Artefatos</span>
                <span class="modulo-nota" id="nota-modulo5">0%</span>
            </div>
            <div class="modulo-mini" id="mini-modulo6">
                <span class="modulo-numero">6</span>
                <span class="modulo-nome">Estimativa e Planejamento</span>
                <span class="modulo-nota" id="nota-modulo6">0%</span>
            </div>
            <div class="modulo-mini" id="mini-modulo7">
                <span class="modulo-numero">7</span>
                <span class="modulo-nome">Scrum Board e Ferramentas</span>
                <span class="modulo-nota" id="nota-modulo7">0%</span>
            </div>
            <div class="modulo-mini" id="mini-modulo8">
                <span class="modulo-numero">8</span>
                <span class="modulo-nome">Boas Pr√°ticas</span>
                <span class="modulo-nota" id="nota-modulo8">0%</span>
            </div>
        </div>
    </details>

    <!-- BOT√ÉO DE ACESSO AO CERTIFICADO -->
    <button id="btn-acessar-certificado" class="btn-certificado btn-bloqueado" disabled>
        <span class="btn-icon">üîí</span>
        <span class="btn-texto">Certificado Bloqueado</span>
        <span class="btn-subtexto">Complete 100% do curso + Exame Final</span>
    </button>
</section>


<script>
    // USAR AS MESMAS CHAVES DO main-script.js
const memoria = {
    exameFinal: { porcentagemAcertos: 'acertosExame' },
    modulo1: { porcentagemAcertos: 'modulo1Acertos' },
    modulo2: { porcentagemAcertos: 'modulo2Acertos' },
    modulo3: { porcentagemAcertos: 'modulo3Acertos' },
    modulo4: { porcentagemAcertos: 'modulo4Acertos' },
    modulo5: { porcentagemAcertos: 'modulo5Acertos' },
    modulo6: { porcentagemAcertos: 'modulo6Acertos' },
    modulo7: { porcentagemAcertos: 'modulo7Acertos' },
    modulo8: { porcentagemAcertos: 'modulo8Acertos' }
};

const gerenciador = {
    getStorage(chave) {
        return JSON.parse(localStorage.getItem(chave));
    }
};

// Verificar certificado quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DEBUG: Verificando Certificado ===');
    verificarCertificado();
});

function verificarCertificado() {
    // Verificar progresso do curso
    const progressoCurso = parseInt(gerenciador.getStorage('porcentagemProgresso')) || 0;
    const checkboxesMarcadas = gerenciador.getStorage('checkboxesValue') || [];
    const totalCheckboxes = 43;
    
    // Verificar nota do Exame Final
    const notaExameFinal = parseFloat(gerenciador.getStorage(memoria.exameFinal.porcentagemAcertos)) || 0;
    
    console.log(`Progresso do curso: ${progressoCurso}%`);
    console.log(`Checkboxes marcadas: ${checkboxesMarcadas.length}/${totalCheckboxes}`);
    console.log(`Nota do Exame Final: ${notaExameFinal}%`);
    
    // Atualizar gr√°fico de progresso circular
    const graficoCanvas = document.getElementById('grafico-progresso-certificado');
    if (graficoCanvas) {
        new Chart(graficoCanvas, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [progressoCurso, 100 - progressoCurso],
                    backgroundColor: [
                        'rgba(255, 255, 255, 0.9)',
                        'rgba(255, 255, 255, 0.2)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                cutout: '75%'
            }
        });
    }
    
    // Atualizar informa√ß√µes visuais
    document.getElementById('progresso-percent-display').textContent = progressoCurso + '%';
    document.getElementById('topicos-concluidos').textContent = `${checkboxesMarcadas.length}/${totalCheckboxes}`;
    
    // Contar exerc√≠cios aprovados
    const modulos = ['modulo1', 'modulo2', 'modulo3', 'modulo4', 
                    'modulo5', 'modulo6', 'modulo7', 'modulo8'];
    
    let aprovados = 0;
    
    modulos.forEach((modulo) => {
        const chaveNota = memoria[modulo].porcentagemAcertos;
        const nota = parseFloat(gerenciador.getStorage(chaveNota)) || 0;
        
        console.log(`${modulo}: ${nota}%`);
        
        // Atualizar nota no detalhe dos m√≥dulos
        const notaElement = document.getElementById(`nota-${modulo}`);
        if (notaElement) {
            notaElement.textContent = nota.toFixed(0) + '%';
            
            // Adicionar cor baseada na nota
            const moduloMini = notaElement.closest('.modulo-mini');
            if (nota >= 70) {
                moduloMini.style.background = 'rgba(16, 185, 129, 0.3)';
                aprovados++;
            } else if (nota > 0) {
                moduloMini.style.background = 'rgba(251, 191, 36, 0.3)';
            } else {
                moduloMini.style.background = 'rgba(255, 255, 255, 0.15)';
            }
        }
    });

    document.getElementById('exercicios-aprovados').textContent = `${aprovados}/8`;
    
    // Atualizar informa√ß√£o do Exame Final
    const exameFinalElement = document.getElementById('exame-final-nota');
    const exameFinalIcon = document.getElementById('exame-final-icon');
    if (exameFinalElement) {
        exameFinalElement.textContent = notaExameFinal.toFixed(0) + '%';
        if (notaExameFinal >= 70) {
            exameFinalIcon.textContent = '‚úÖ';
            exameFinalIcon.style.color = '#10b981';
        } else if (notaExameFinal > 0) {
            exameFinalIcon.textContent = '‚ùå';
            exameFinalIcon.style.color = '#ef4444';
        } else {
            exameFinalIcon.textContent = '‚è≥';
            exameFinalIcon.style.color = '#f59e0b';
        }
    }
    
    // Atualizar status
    const statusIcon = document.getElementById('status-icon');
    const statusTexto = document.getElementById('status-texto');
    const statusMensagem = document.getElementById('status-mensagem');
    
    // NOVA L√ìGICA: Curso completo = 100% progresso + Exame Final >= 70%
    const cursoCompleto = progressoCurso === 100 && 
                          checkboxesMarcadas.length === totalCheckboxes && 
                          notaExameFinal >= 70;
    
    if (cursoCompleto) {
        statusIcon.textContent = 'üéâ';
        statusTexto.textContent = 'Conclu√≠do!';
        statusMensagem.textContent = 'Parab√©ns pela conquista!';
    } else if (progressoCurso === 100 && notaExameFinal < 70) {
        statusIcon.textContent = 'üìù';
        statusTexto.textContent = 'Falta o Exame Final!';
        statusMensagem.textContent = 'Complete o exame com 70% de acertos ou mais';
    } else if (progressoCurso >= 75) {
        statusIcon.textContent = 'üî•';
        statusTexto.textContent = 'Quase l√°!';
        statusMensagem.textContent = `Faltam ${100 - progressoCurso}%`;
    } else if (progressoCurso >= 50) {
        statusIcon.textContent = 'üí™';
        statusTexto.textContent = '√ìtimo progresso!';
        statusMensagem.textContent = 'Continue assim!';
    } else if (progressoCurso > 0) {
        statusIcon.textContent = 'üöÄ';
        statusTexto.textContent = 'Em andamento';
        statusMensagem.textContent = 'Voc√™ est√° indo bem!';
    } else {
        statusIcon.textContent = '‚è≥';
        statusTexto.textContent = 'N√£o iniciado';
        statusMensagem.textContent = 'Comece agora!';
    }

    // Atualizar bot√£o e se√ß√£o do certificado
    const btnCertificado = document.getElementById('btn-acessar-certificado');
    const certificadoSection = document.getElementById('certificado-section');

    if (cursoCompleto) {
        btnCertificado.disabled = false;
        btnCertificado.classList.remove('btn-bloqueado');
        btnCertificado.querySelector('.btn-icon').textContent = 'üéì';
        btnCertificado.querySelector('.btn-texto').textContent = 'Acessar Meu Certificado';
        btnCertificado.querySelector('.btn-subtexto').textContent = 'Clique para baixar';
        btnCertificado.onclick = () => window.location.href = '/certificado';
        certificadoSection.classList.remove('certificado-bloqueado');
        
        // Confetti
        setTimeout(() => {
            confetti();
        }, 500);
    } else {
        btnCertificado.disabled = true;
        btnCertificado.classList.add('btn-bloqueado');
        btnCertificado.querySelector('.btn-icon').textContent = 'üîí';
        btnCertificado.querySelector('.btn-texto').textContent = 'Certificado Bloqueado';
        
        // Mensagem din√¢mica no bot√£o
        if (progressoCurso === 100 && notaExameFinal < 70) {
            btnCertificado.querySelector('.btn-subtexto').textContent = 'Complete o Exame Final com 70% ou mais';
        } else {
            btnCertificado.querySelector('.btn-subtexto').textContent = 'Complete 100% do curso + Exame Final';
        }
        
        btnCertificado.onclick = () => {
            btnCertificado.classList.add('shake');
            setTimeout(() => btnCertificado.classList.remove('shake'), 500);
        };
    }
}

// Fun√ß√£o de confetti
function confetti() {
    const duration = 3000;
    const end = Date.now() + duration;

    (function frame() {
        const timeLeft = end - Date.now();
        if (timeLeft <= 0) return;

        const particleCount = 2;
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.style.position = 'fixed';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = '-10px';
            particle.style.width = '10px';
            particle.style.height = '10px';
            particle.style.backgroundColor = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'][Math.floor(Math.random() * 4)];
            particle.style.borderRadius = '50%';
            particle.style.zIndex = '9999';
            particle.style.animation = 'fall 3s linear';
            
            document.body.appendChild(particle);
            
            setTimeout(() => particle.remove(), 3000);
        }

        requestAnimationFrame(frame);
    }());
}

</script>
{% endblock %}