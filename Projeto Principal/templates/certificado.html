{% extends 'base.html' %}

{% block title %}Meu Certificado | SCRUM ACADEMY{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="certificado-container">
    <div class="parabens">
        <h2>üéâ Parab√©ns pela sua conquista!</h2>
        <p>
            Voc√™ completou todos os m√≥dulos do curso de Metodologia Scrum com excel√™ncia!
            Este certificado comprova seu dom√≠nio dos conceitos e pr√°ticas essenciais do Scrum.
        </p>
        <p style="margin-top: 1rem;">
            <strong>Digite seu nome completo abaixo para personalizar o certificado:</strong>
        </p>
        <input type="text" id="input-nome-aluno" class="input-nome" placeholder="Seu nome completo" value="Aluno(a) Scrum">
    </div>

    <div class="certificado-preview" id="certificado-preview">
        <div class="selo-qualidade">
            ‚òÖ<br>SCRUM<br>ACADEMY
        </div>
        
        <div class="certificado-header">
            <h1>CERTIFICADO</h1>
            <h2>de Conclus√£o</h2>
        </div>

        <div class="certificado-body">
            <p>Certificamos que</p>
            <div class="nome-aluno" id="nome-aluno-display">ALUNO(A) SCRUM</div>
            <p>concluiu com √™xito o curso de</p>
            <div class="curso-nome">METODOLOGIA SCRUM</div>
            <p>
                com carga hor√°ria de <strong>20 horas</strong>, demonstrando profici√™ncia<br>
                em todos os m√≥dulos do programa SCRUM ACADEMY,<br>
                incluindo fundamentos √°geis, pap√©is, eventos, artefatos e boas pr√°ticas.
            </p>

            <div class="data-conclusao" id="data-conclusao">
                Conclu√≠do em: <span id="data-display"></span>
            </div>
        </div>

        <div class="certificado-footer">
            <div class="assinatura">
                <div class="assinatura-linha"></div>
                <p><strong>SCRUM ACADEMY</strong></p>
                <p>Coordena√ß√£o do Curso</p>
            </div>
            <div class="assinatura">
                <div class="assinatura-linha"></div>
                <p><strong>Certifica√ß√£o Digital</strong></p>
                <p>ID: SA-2025-{{ range(1000, 9999) | random }}</p>
            </div>
        </div>
    </div>

    <div class="acoes-certificado">
        <button onclick="baixarPDF()" class="btn-acao btn-download">
            üì• Baixar PDF
        </button>
        <button onclick="compartilharCertificado()" class="btn-acao btn-compartilhar">
            üîó Compartilhar
        </button>
        <a href="{{ url_for('notas') }}" class="btn-acao btn-voltar">
            ‚Üê Voltar para Notas
        </a>
    </div>
</div>

<script>
    // USAR AS MESMAS CHAVES DO main-script.js
    const memoria = {
        modulo1: { porcentagemAcertos: 'modulo1Acertos' },
        modulo2: { porcentagemAcertos: 'modulo2Acertos' },
        modulo3: { porcentagemAcertos: 'modulo3Acertos' },
        modulo4: { porcentagemAcertos: 'modulo4Acertos' },
        modulo5: { porcentagemAcertos: 'modulo5Acertos' },
        modulo6: { porcentagemAcertos: 'modulo6Acertos' },
        modulo7: { porcentagemAcertos: 'modulo7Acertos' },
        modulo8: { porcentagemAcertos: 'modulo8Acertos' }
    };

    const gerenciador = {
        getStorage(chave) {
            return JSON.parse(localStorage.getItem(chave));
        }
    };

    // Atualizar data atual
    document.getElementById('data-display').textContent = new Date().toLocaleDateString('pt-BR');

    // Atualizar nome em tempo real
    const inputNome = document.getElementById('input-nome-aluno');
    const nomeDisplay = document.getElementById('nome-aluno-display');

    inputNome.addEventListener('input', function() {
        const nome = this.value.trim() || 'ALUNO(A) SCRUM';
        nomeDisplay.textContent = nome.toUpperCase();
    });

    // Carregar nome salvo se existir
    const nomeSalvo = localStorage.getItem('nome_aluno');
    if (nomeSalvo) {
        inputNome.value = nomeSalvo;
        nomeDisplay.textContent = nomeSalvo.toUpperCase();
    }

    // Salvar nome ao digitar
    inputNome.addEventListener('change', function() {
        localStorage.setItem('nome_aluno', this.value);
    });

    // Fun√ß√£o para baixar PDF
    async function baixarPDF() {
        const nome = inputNome.value.trim() || 'Aluno';
        
        try {
            const response = await fetch('/api/gerar-certificado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ nome: nome })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificado_SCRUM_${nome.replace(/\s/g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('‚úÖ Certificado baixado com sucesso!');
            } else {
                alert('‚ùå Erro ao gerar o certificado. Tente novamente.');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('‚ùå Erro ao baixar o certificado. Tente novamente.');
        }
    }

    // Fun√ß√£o para compartilhar
    function compartilharCertificado() {
        const nome = inputNome.value.trim() || 'Aluno';
        const texto = `üéì Acabei de concluir o curso de Metodologia Scrum na SCRUM ACADEMY! 

Todos os m√≥dulos completos com notas acima de 70%! üí™

#Scrum #Agile #Certifica√ß√£o #DesenvolvimentoProfissional`;

        if (navigator.share) {
            navigator.share({
                title: 'Certificado SCRUM ACADEMY',
                text: texto,
            }).then(() => {
                console.log('Compartilhado com sucesso!');
            }).catch((error) => {
                console.log('Erro ao compartilhar:', error);
                copiarTexto(texto);
            });
        } else {
            copiarTexto(texto);
        }
    }

    function copiarTexto(texto) {
        navigator.clipboard.writeText(texto).then(() => {
            alert('‚úÖ Texto copiado! Cole nas suas redes sociais.');
        }).catch(() => {
            alert('‚ùå N√£o foi poss√≠vel copiar. Tente manualmente.');
        });
    }

    // Verificar se o usu√°rio tem permiss√£o para acessar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== VERIFICANDO ACESSO AO CERTIFICADO ===');
        
        const memoria = {
            exameFinal: { porcentagemAcertos: 'acertosExame' }
        };
        
        const gerenciador = {
            getStorage(chave) {
                return JSON.parse(localStorage.getItem(chave));
            }
        };
        
        const progressoCurso = parseInt(gerenciador.getStorage('porcentagemProgresso')) || 0;
        const checkboxesMarcadas = gerenciador.getStorage('checkboxesValue') || [];
        const totalCheckboxes = 43;
        const notaExameFinal = parseFloat(gerenciador.getStorage(memoria.exameFinal.porcentagemAcertos)) || 0;
        
        console.log(`Progresso: ${progressoCurso}%`);
        console.log(`Checkboxes: ${checkboxesMarcadas.length}/${totalCheckboxes}`);
        console.log(`Exame Final: ${notaExameFinal}%`);
        
        const cursoCompleto = progressoCurso === 100 && 
                            checkboxesMarcadas.length === totalCheckboxes && 
                            notaExameFinal >= 70;
        
        console.log(`Acesso permitido: ${cursoCompleto}`);

        if (!cursoCompleto) {
            let mensagemErro = '‚ö†Ô∏è Voc√™ ainda n√£o completou todos os requisitos para o certificado!\n\n';
            
            if (progressoCurso < 100) {
                mensagemErro += `üìö Progresso atual: ${progressoCurso}%\n`;
                mensagemErro += `   T√≥picos conclu√≠dos: ${checkboxesMarcadas.length}/${totalCheckboxes}\n\n`;
            }
            
            if (notaExameFinal < 70) {
                if (notaExameFinal === 0) {
                    mensagemErro += 'üìù Exame Final: N√ÉO REALIZADO\n';
                    mensagemErro += '   Voc√™ precisa fazer o Exame Final e obter pelo menos 70%\n\n';
                } else {
                    mensagemErro += `üìù Exame Final: ${notaExameFinal.toFixed(0)}% (necess√°rio: 70%)\n`;
                    mensagemErro += '   Refa√ßa o exame para melhorar sua nota\n\n';
                }
            }
            
            mensagemErro += 'Complete todos os requisitos para desbloquear o certificado.';
            
            alert(mensagemErro);
            window.location.href = '/notas';
        } else {
            console.log('‚úÖ Acesso permitido! Exibindo certificado.');
        }
    });
</script>
{% endblock %}